name: Mobile Build

on:
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - android
          - ios
  workflow_call:
    inputs:
      version:
        description: 'Version label for artifacts (e.g. 1.0.0)'
        required: false
        type: string
        default: 'dev'

# ──────────────────────────────────────────────────────────────────────
# Required GitHub Secrets (Settings → Secrets and variables → Actions):
#
# ANDROID SIGNING:
#   ANDROID_KEYSTORE_BASE64   – Base64-encoded release keystore file
#                                (generate: base64 -i release.keystore | pbcopy)
#   ANDROID_KEYSTORE_PASSWORD – Password for the keystore
#   ANDROID_KEY_ALIAS         – Alias of the signing key
#   ANDROID_KEY_PASSWORD      – Password for the signing key
#
# iOS SIGNING:
#   IOS_CERTIFICATE_BASE64           – Base64-encoded .p12 distribution certificate
#   IOS_CERTIFICATE_PASSWORD         – Password for the .p12 certificate
#   IOS_PROVISIONING_PROFILE_BASE64  – Base64-encoded .mobileprovision file
#   IOS_TEAM_ID                      – Apple Developer Team ID
# ──────────────────────────────────────────────────────────────────────

env:
  NODE_VERSION: '22'
  PNPM_VERSION: '10.28.2'
  JAVA_VERSION: '17'
  MOBILE_DIR: apps/mobile

jobs:
  # ════════════════════════════════════════════════════════════════════
  # Android Build
  # ════════════════════════════════════════════════════════════════════
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.platform == 'all' || inputs.platform == 'android' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ── Android signing (only when secrets are available) ──────────
      - name: Decode Android keystore
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > ${{ env.MOBILE_DIR }}/android/app/release.keystore

      - name: Configure release signing
        if: ${{ env.ANDROID_KEYSTORE_BASE64 != '' }}
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          cat >> ${{ env.MOBILE_DIR }}/android/gradle.properties <<EOF
          RELEASE_STORE_FILE=release.keystore
          RELEASE_STORE_PASSWORD=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS=${{ secrets.ANDROID_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      # ── Prebuild + Build ──────────────────────────────────────────
      - name: Expo prebuild
        working-directory: ${{ env.MOBILE_DIR }}
        run: pnpm exec expo prebuild --clean

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ${{ env.MOBILE_DIR }}/android/.gradle
          key: gradle-${{ runner.os }}-${{ hashFiles('apps/mobile/android/**/*.gradle*', 'apps/mobile/android/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Build Android release APK
        working-directory: ${{ env.MOBILE_DIR }}/android
        run: ./gradlew assembleRelease --no-daemon

      # ── Upload artifact ───────────────────────────────────────────
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: mobile-android-${{ inputs.version || 'dev' }}
          path: ${{ env.MOBILE_DIR }}/android/app/build/outputs/apk/release/*.apk
          retention-days: 30

  # ════════════════════════════════════════════════════════════════════
  # iOS Build
  # ════════════════════════════════════════════════════════════════════
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    if: ${{ github.event_name != 'workflow_dispatch' || inputs.platform == 'all' || inputs.platform == 'ios' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ── iOS signing (only when secrets are available) ──────────────
      - name: Install Apple certificate and provisioning profile
        if: ${{ env.IOS_CERTIFICATE_BASE64 != '' }}
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          # Create temp keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # Import certificate
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          echo "$IOS_CERTIFICATE_BASE64" | base64 --decode > "$CERTIFICATE_PATH"
          security import "$CERTIFICATE_PATH" \
            -P "$IOS_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 \
            -k "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: \
            -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"

          # Install provisioning profile
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode > "$PP_PATH"
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          PP_UUID=$(/usr/libexec/PlistBuddy -c "Print :UUID" /dev/stdin <<< \
            $(security cms -D -i "$PP_PATH"))
          cp "$PP_PATH" ~/Library/MobileDevice/Provisioning\ Profiles/"$PP_UUID".mobileprovision

      # ── Prebuild + Build ──────────────────────────────────────────
      - name: Expo prebuild
        working-directory: ${{ env.MOBILE_DIR }}
        run: pnpm exec expo prebuild --clean

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: ${{ env.MOBILE_DIR }}/ios/Pods
          key: pods-${{ runner.os }}-${{ hashFiles('apps/mobile/ios/Podfile.lock') }}
          restore-keys: |
            pods-${{ runner.os }}-

      - name: Install CocoaPods
        working-directory: ${{ env.MOBILE_DIR }}/ios
        run: pod install

      - name: Build iOS (unsigned archive)
        working-directory: ${{ env.MOBILE_DIR }}
        run: |
          xcodebuild \
            -workspace ios/mobile.xcworkspace \
            -scheme mobile \
            -configuration Release \
            -sdk iphoneos \
            -derivedDataPath ios/build \
            CODE_SIGN_IDENTITY="${{ secrets.IOS_CERTIFICATE_BASE64 != '' && 'Apple Distribution' || '-' }}" \
            CODE_SIGNING_REQUIRED="${{ secrets.IOS_CERTIFICATE_BASE64 != '' && 'YES' || 'NO' }}" \
            CODE_SIGNING_ALLOWED="${{ secrets.IOS_CERTIFICATE_BASE64 != '' && 'YES' || 'NO' }}" \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
            -allowProvisioningUpdates \
            | xcbeautify || true

      # ── Upload artifact ───────────────────────────────────────────
      - name: Upload iOS build
        uses: actions/upload-artifact@v4
        with:
          name: mobile-ios-${{ inputs.version || 'dev' }}
          path: ${{ env.MOBILE_DIR }}/ios/build/Build/Products/Release-iphoneos/
          retention-days: 30

      # ── Cleanup keychain ──────────────────────────────────────────
      - name: Cleanup signing
        if: always()
        run: |
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db 2>/dev/null || true
          rm -f $RUNNER_TEMP/build_certificate.p12
          rm -f $RUNNER_TEMP/build_pp.mobileprovision
